name: ImmortalWRT Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Checkout ImmortalWRT source
        uses: actions/checkout@v4
        with:
          repository: immortalwrt/immortalwrt
          path: immortalwrt
          fetch-depth: 1
          
      - name: Prepare DTB file
        run: |
          # 创建 DTB文件内容
          cat > immortalwrt/target/linux/mediatek/dts/wma301v2.dts << 'EOF'
          /dts-v1/;

          / {
          	compatible = "mediatek,mt7981-spim-snand-rfb";
          	interrupt-parent = <0x01>;
          	#address-cells = <0x02>;
          	#size-cells = <0x02>;
          	model = "MediaTek MT7981 RFB";

          	cpus {
          		#address-cells = <0x01>;
          		#size-cells = <0x00>;

          		cpu@0 {
          			device_type = "cpu";
          			compatible = "arm,cortex-a53";
          			enable-method = "psci";
          			reg = <0x00>;
          		};

          		cpu@1 {
          			device_type = "cpu";
          			compatible = "arm,cortex-a53";
          			enable-method = "psci";
          			reg = <0x01>;
          		};
          	};

          	/* 这里省略了大部分DTB内容 */
          };
          EOF
