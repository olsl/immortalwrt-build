name: ç¼–è¯‘ ImmortalWrt å›ºä»¶
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      TARGET: mediatek
      SUBTARGET: filogic
      DTS_FILE: mt7981b-wma301-ax3000-v2.dts
      PROFILE: WMA301_AX3000
    steps:
    - name: ðŸ§¹ æ¸…ç†ç©ºé—´ï¼ˆå¯é€‰ï¼‰
      run: sudo rm -rf /usr/share/dotnet /opt/ghc && docker image prune -af || true

    - name: ðŸ” è°ƒè¯•ï¼šåˆ—å‡ºä»“åº“åˆå§‹æ–‡ä»¶
      run: |
        echo "ðŸ“ å½“å‰ä»“åº“æ ¹ç›®å½•æ–‡ä»¶ï¼š"
        find . -type f | sort

    - name: ðŸ“‚ å¤‡ä»½ DTS æ–‡ä»¶ï¼ˆé˜²æ­¢ git clone è¦†ç›–ï¼‰
      run: |
        echo "ðŸ“¦ æ­£åœ¨å¤‡ä»½ DTS æ–‡ä»¶..."
        mkdir -p ./temp-dts
        if [ ! -f "dts/${DTS_FILE}" ]; then
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° dts/${DTS_FILE}"
          echo "ðŸ’¡ è§£å†³æ–¹æ³•ï¼š"
          echo "   1. ç¡®ä¿æ–‡ä»¶å·²æäº¤åˆ°ä»“åº“ï¼šgit add dts/"
          echo "   2. æ–‡ä»¶åå®Œå…¨åŒ¹é…ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰"
          echo "   3. .gitignore æœªå¿½ç•¥ *.dts"
          exit 1
        fi
        cp "dts/${DTS_FILE}" ./temp-dts/
        echo "âœ… æˆåŠŸå¤‡ä»½ ${DTS_FILE} åˆ°ä¸´æ—¶ç›®å½•"

    - name: ðŸ“¥ å…‹éš† ImmortalWrt æºç 
      run: |
        git clone -b openwrt-23.05 --depth 1 https://github.com/immortalwrt/immortalwrt source
        cd source
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ðŸ“ å¤åˆ¶ DTS åˆ°ç›®æ ‡æž¶æž„ç›®å½•
      run: |
        cd source
        DTS_DIR="target/linux/${TARGET}/dts"
        mkdir -p "${DTS_DIR}"
        cp "../temp-dts/${DTS_FILE}" "${DTS_DIR}/"
        echo "âœ… DTS æ–‡ä»¶å·²å°±ä½ï¼š${DTS_DIR}/${DTS_FILE}"

    - name: ðŸ”§ æ³¨å†Œæ–°è®¾å¤‡
      run: >-
        DIR="source/target/linux/mediatek/filogic/image";
        MAKEFILE="$DIR/Makefile";
        mkdir -p "$DIR";
        if [ ! -f "$MAKEFILE" ]; then
          echo 'include \$(INCLUDE_DIR)/image.mk' > "$MAKEFILE";
        fi;
        if ! grep -q "define Device/WMA301_AX3000" "$MAKEFILE"; then
          echo 'define Device/WMA301_AX3000' >> "$MAKEFILE";           echo '  $(Device/filogic)' >> "$MAKEFILE";           echo '  DEVICE_VENDOR := Wma301' >> "$MAKEFILE";           echo '  DEVICE_MODEL := mt7981b-wma301-ax3000' >> "$MAKEFILE";           echo '  DEVICE_DTS := mt7981b-wma301-ax3000-v2' >> "$MAKEFILE";           echo '  DEVICE_PACKAGES := wpad-basic-mbedtls kmod-leds-gpio kmod-input-gpio-buttons kmod-mt7915 kmod-mt7531ae luci relayd odhcpd-ipv6only samba36-server kmod-usb-printer kmod-of-mediatek-pinctrl' >> "$MAKEFILE";           echo '  SUPPORTED_DEVICES += mt7981b-wma301-ax3000-v2' >> "$MAKEFILE";           echo 'endef' >> "$MAKEFILE";           echo 'TARGET_DEVICES += WMA301_AX3000' >> "$MAKEFILE"
        fi

    - name: ðŸŽ›ï¸ ç”Ÿæˆé…ç½®æ–‡ä»¶ .config
      run: |
        cd source
        touch .config
        echo 'CONFIG_TARGET_mediatek=y' >> .config
        echo 'CONFIG_TARGET_mediatek_filogic=y' >> .config
        echo 'CONFIG_TARGET_mediatek_filogic_DEVICE_WMA301_AX3000=y' >> .config
        echo 'CONFIG_PACKAGE_u-boot-mediatek=y' >> .config
        echo 'CONFIG_PACKAGE_u-boot-mediatek-images=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-leds-gpio=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-input-gpio-buttons=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-of-mediatek-pinctrl=y' >> .config
        echo 'CONFIG_PACKAGE_luci=y' >> .config
        echo 'CONFIG_PACKAGE_relayd=y' >> .config
        echo 'CONFIG_PACKAGE_odhcpd-ipv6only=y' >> .config
        echo 'CONFIG_PACKAGE_samba36-server=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-usb-printer=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-mt7915=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-mt7915=y' >> .config
        echo 'CONFIG_PACKAGE_kmod-mt7531ae=y' >> .config
        make defconfig

    - name: ðŸ—ï¸ å¼€å§‹ç¼–è¯‘å›ºä»¶
      run: |
        cd source
        echo "â³ æ­£åœ¨ç¼–è¯‘... ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹"
        make -j$(nproc) V=s

    - name: ðŸ” æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶å¤§å°
      run: |
        cd source
        for f in bin/targets/*/*/openwrt-*-*-squashfs-sysupgrade.bin; do
          [ -f "$f" ] || continue
          sz=$(stat -c%s "$f")
          echo "$f -> $sz å­—èŠ‚"
          if [ $sz -gt 134217728 ]; then
            echo "âŒ å›ºä»¶è¶…å‡º 128MB é™åˆ¶ ($sz > 134217728)"
            exit 1
          fi
        done

    - name: ðŸ“¦ ä¸Šä¼ ç¼–è¯‘å¥½çš„å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.run_number }}
        path: source/bin/targets/${TARGET}/${SUBTARGET}/**
        retention-days: 90