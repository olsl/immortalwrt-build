name: Build ImmortalWrt for Custom MT798x Device

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      DEVICE_DTS_DIR: dts
      TARGET: mediatek
      SUBTARGET: mt798x
      IMAGE_SIZE: 65536k
      KERNEL_SIZE: 16128k
      REPO_URL: https://github.com/immortalwrt/immortalwrt.git
      BRANCH: openwrt-23.05

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Find DTS Files
      id: find_dts
      run: |
        if [ ! -d "${{ env.DEVICE_DTS_DIR }}" ]; then
          echo "‚ùå Directory '/${{ env.DEVICE_DTS_DIR }}' not found!"; exit 1;
        fi
        DTS_FILES=$(find ${{ env.DEVICE_DTS_DIR }} -name "*.dts" -type f)
        if [ -z "$DTS_FILES" ]; then
          echo "‚ùå No .dts file found in /${{ env.DEVICE_DTS_DIR }}/"; exit 1;
        fi
        FIRST_DTS=$(echo "$DTS_FILES" | head -n1)
        DEVICE_NAME=$(basename "$FIRST_DTS" .dts)
        echo "device_name=$DEVICE_NAME" >> "$GITHUB_OUTPUT"
        echo "device_dts_path=$FIRST_DTS" >> "$GITHUB_OUTPUT"
        echo "‚úÖ Using device: $DEVICE_NAME"

    - name: Setup ImmortalWrt Source
      run: |
        mkdir -p "$GITHUB_WORKSPACE/openwrt/source"
        cd "$GITHUB_WORKSPACE/openwrt/source"
        git clone --depth 1 -b ${{ env.BRANCH }} ${{ env.REPO_URL }} .
        echo "‚úÖ Source code cloned."

    - name: Copy User DTS to Target Directory
      run: |
        DST="target/linux/mediatek/files-5.15/arch/arm64/boot/dts/mediatek"
        mkdir -p "$GITHUB_WORKSPACE/openwrt/source/$DST"
        cp ${{ steps.find_dts.outputs.device_dts_path }} \
           "$GITHUB_WORKSPACE/openwrt/source/$DST/${{ steps.find_dts.outputs.device_name }}.dts"
        echo "‚úÖ DTS copied to source tree."

    - name: Check if Device Already Supported
      id: check_device
      run: |
        MK="$GITHUB_WORKSPACE/openwrt/source/target/linux/mediatek/image/mt798x.mk"
        NAME=${{ steps.find_dts.outputs.device_name }}
        if grep -q "define Device/$NAME" "$MK"; then
          echo "already_supported=true" >> "$GITHUB_OUTPUT";
        else
          echo "already_supported=false" >> "$GITHUB_OUTPUT";
        fi

    - name: Register New Device (if not exists)
      if: steps.check_device.outputs.already_supported == 'false'
      run: |
        MK="$GITHUB_WORKSPACE/openwrt/source/target/linux/mediatek/image/mt798x.mk"
        NAME=${{ steps.find_dts.outputs.device_name }}
        echo "" >> "$MK"
        echo "# Auto-registered by CI for $NAME" >> "$MK"
        echo "define Device/$NAME" >> "$MK"
        echo "  DEVICE_VENDOR := Custom" >> "$MK"
        echo "  DEVICE_MODEL := $NAME" >> "$MK"
        echo "  DEVICE_DTS := $NAME" >> "$MK"
        echo "  DEVICE_PACKAGES := \\" >> "$MK"
        echo "    kmod-usb-core kmod-usb-ohci kmod-usb2 kmod-usb-ledtrig-usbport \\" >> "$MK"
        echo "    block-mount e2fsprogs fdisk usbutils lsblk printenv \\" >> "$MK"
        echo "    p910nd samba4-server samba4-client \\" >> "$MK"
        echo "    kmod-fs-ntfs ntfs-3g mount.ntfs \\" >> "$MK"
        echo "    luci luci-ssl luci-i18n-base-zh-cn \\" >> "$MK"
        echo "    odhcp6c odhcpd-ipv6only \\" >> "$MK"
        echo "    wpad-basic-wolfssl hostapd-common \\" >> "$MK"
        echo "    kmod-ipt-nat6" >> "$MK"
        echo "  KERNEL_SIZE := ${{ env.KERNEL_SIZE }}" >> "$MK"
        echo "  IMAGE_SIZE := ${{ env.IMAGE_SIZE }}" >> "$MK"
        echo "  IMAGES += factory.bin sysupgrade.bin" >> "$MK"
        echo "  IMAGE/factory.bin := \$$(sysupgrade_bin) | check-size \$\$\$(IMAGE_SIZE)" >> "$MK"
        echo "  IMAGE/sysupgrade.bin := \$$(sysupgrade_bin) | check-size \$\$\$(IMAGE_SIZE)" >> "$MK"
        echo "endef" >> "$MK"
        echo "TARGET_DEVICES += $NAME" >> "$MK"
        echo "‚úÖ Registered new device: $NAME"

    - name: Write .config with Target Configuration
      run: |
        DIR="$GITHUB_WORKSPACE/openwrt/source"
        cd "$DIR"
        cat > .config << EOF
CONFIG_TARGET_${{ env.TARGET }}=y
CONFIG_TARGET_${{ env.SUBTARGET }}=y
CONFIG_TARGET_${{ env.SUBTARGET }}_DEVICE_${{ steps.find_dts.outputs.device_name }}=y
CONFIG_DEVEL=y
CONFIG_BUILD_LOG=y
CONFIG_CCACHE=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
CONFIG_PACKAGE_kmod-usb-core=y
CONFIG_PACKAGE_kmod-usb-ohci=y
CONFIG_PACKAGE_kmod-usb2=y
CONFIG_PACKAGE_kmod-usb-ledtrig-usbport=y
CONFIG_PACKAGE_usbutils=y
CONFIG_PACKAGE_lsusb=y
CONFIG_PACKAGE_kmod-usb-printer=y
CONFIG_PACKAGE_p910nd=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_e2fsprogs=y
CONFIG_PACKAGE_fdisk=y
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-ntfs=y
CONFIG_PACKAGE_ntfs-3g=y
CONFIG_PACKAGE_mount.ntfs=y
CONFIG_PACKAGE_samba4-server=y
CONFIG_PACKAGE_samba4-client=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_kmod-ipt-nat6=y
CONFIG_PACKAGE_kmod-ip6tables=y
CONFIG_PACKAGE_hostapd-common=y
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_iwinfo=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_ping6=y
CONFIG_PACKAGE_netstat=y
CONFIG_PACKAGE_tcpdump=y
EOF
        echo "‚úÖ .config generated."

    - name: Update Feeds
      working-directory: $GITHUB_WORKSPACE/openwrt/source
      run: |
        ./scripts/feeds update -a && ./scripts/feeds install -a
        echo "‚úÖ Feeds updated."

    - name: Start Compilation
      working-directory: $GITHUB_WORKSPACE/openwrt/source
      run: |
        make defconfig
        echo "üöÄ Starting build..."
        make -j$(nproc) || { echo "‚ùå Build failed!"; exit 1; }

    - name: Find Firmware Output
      id: find_firmware
      run: |
        BUILD_DIR="$GITHUB_WORKSPACE/openwrt/source/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}"
        FILES=$(find "$BUILD_DIR" -name "*${{ steps.find_dts.outputs.device_name }}*.bin" -type f 2>/dev/null || true)
        if [ -z "$FILES" ]; then
          echo "‚ùå No firmware built!";
          ls -la "$BUILD_DIR" || true;
          exit 1;
        fi
        echo "firmware_dir=$(dirname $FILES)" >> "$GITHUB_OUTPUT"
        echo "üìÑ Built:"; ls -lh $FILES

    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        path: ${{ steps.find_firmware.outputs.firmware_dir }}/*.bin
        if-no-files-found: error
        retention-days: 7

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="v$(date +%Y%m%d)-${{ steps.find_dts.outputs.device_name }}"
        gh release create "$TAG" \
          --title "üì¶ Auto-Build for ${{ steps.find_dts.outputs.device_name }}" \
          --notes "Built by GitHub Actions with LuCI, USB Printer, Samba, IPv6, Repeater support." \
          --draft=false \
          ${{ steps.find_firmware.outputs.firmware_dir }}/*.bin || echo "‚ö†Ô∏è Release may already exist."
