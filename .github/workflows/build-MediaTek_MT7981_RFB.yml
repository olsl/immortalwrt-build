name: ğŸ› ï¸ ç¼–è¯‘ ImmortalWrt å›ºä»¶

on:
  workflow_dispatch:
    inputs:
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡åç§°'
        default: 'MediaTek MT7981 RFB'
        required: false

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    env:
      TARGET: mediatek
      SUBTARGET: filogic
      DEVICE_PROFILE: V2_
      DTS_FILENAME: mt7981b-wma301-ax3000-v2-.dts
      DTS_BASENAME: mt7981b-wma301-ax3000-v2-

    steps:
    - name: ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
      run: |
        df -h
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
        docker image prune -a -f || true

    - name: ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libncurses-dev \
          zlib1g-dev \
          gawk flex bison \
          openssl libssl-dev \
          gettext libelf-dev \
          device-tree-compiler \
          rsync git-core \
          python3 unzip \
          libtool-bin automake pkg-config ccache

    - name: ğŸ“‚ æ£€å‡ºæºç 
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: ğŸ“¥ å…‹éš† ImmortalWrt æºç 
      run: |
        git clone -b openwrt-23.05 --depth 1 https://github.com/immortalwrt/immortalwrt source
        cd source
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ğŸ“ å‡†å¤‡ DTS æ–‡ä»¶
      run: |
        # æ£€æŸ¥ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨ dts ç›®å½•
        if [ ! -d "dts" ]; then
          echo "âŒ æœªæ‰¾åˆ° dts ç›®å½•ï¼è¯·å°† DTS æ–‡ä»¶æ”¾åœ¨ä»“åº“æ ¹ç›®å½•çš„ dts/ ç›®å½•ä¸‹"
          echo "âœ… æ­£ç¡®ç»“æ„ç¤ºä¾‹:"
          echo "   â”œâ”€â”€ dts/"
          echo "   â”‚   â””â”€â”€ ${{ env.DTS_FILENAME }}"
          echo "   â””â”€â”€ .github/workflows/build.yml"
          exit 1
        fi
        
        # æ£€æŸ¥ DTS æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "dts/${{ env.DTS_FILENAME }}" ]; then
          echo "âŒ æœªæ‰¾åˆ° DTS æ–‡ä»¶: dts/${{ env.DTS_FILENAME }}"
          echo "âœ… è¯·ç¡®ä¿æ–‡ä»¶å·²ä¸Šä¼ åˆ° dts/ ç›®å½•"
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ° DTS æ–‡ä»¶: dts/${{ env.DTS_FILENAME }}"
        cat dts/${{ env.DTS_FILENAME }} | head -n 5

    - name: ğŸ“‚ å°† DTS æ–‡ä»¶å¤åˆ¶åˆ°æºç æ ‘
      run: |
        cd source
        # åˆ›å»ºç›®æ ‡ç›®å½•
        mkdir -p target/linux/${{ env.TARGET }}/dts
        
        # å¤åˆ¶ DTS æ–‡ä»¶
        cp ../dts/${{ env.DTS_FILENAME }} target/linux/${{ env.TARGET }}/dts/
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®æ”¹ Makefile
        MAKEFILE="target/linux/${{ env.TARGET }}/${{ env.SUBTARGET }}/Makefile"
        if [ -f "$MAKEFILE" ]; then
          echo "âœ… æ£€æµ‹åˆ° Makefile: $MAKEFILE"
          
          # æ£€æŸ¥æ˜¯å¦å·²åŒ…å« DTS
          if ! grep -q "${{ env.DTS_BASENAME }}.dtb" "$MAKEFILE"; then
            echo "ğŸ”§ æ­£åœ¨æ›´æ–° Makefile ä»¥åŒ…å«æ–° DTS..."
            
            # å¤‡ä»½ Makefile
            cp "$MAKEFILE" "$MAKEFILE.bak"
            
            # æ·»åŠ  DTS åˆ° DEVICE_DTS_CONFIG
            if grep -q "DEVICE_DTS_CONFIG" "$MAKEFILE"; then
              sed -i "/DEVICE_DTS_CONFIG/a \	${{ env.DTS_BASENAME }}.dtb \\" "$MAKEFILE"
            else
              # å¦‚æœæ²¡æœ‰ DEVICE_DTS_CONFIGï¼Œå°è¯•æ·»åŠ åˆ° DEVICE_DTS
              if grep -q "DEVICE_DTS += " "$MAKEFILE"; then
                sed -i "s/DEVICE_DTS += .*/& \${{ env.DTS_BASENAME }}/" "$MAKEFILE"
              else
                # ä½œä¸ºæœ€åæ‰‹æ®µï¼Œç›´æ¥æ·»åŠ 
                echo "" >> "$MAKEFILE"
                echo "# æ·»åŠ è‡ªå®šä¹‰è®¾å¤‡" >> "$MAKEFILE"
                echo "define Device/${{ env.DEVICE_PROFILE }}" >> "$MAKEFILE"
                echo "  $(Device/${{ env.TARGET }})" >> "$MAKEFILE"
                echo "  DEVICE_VENDOR := Custom" >> "$MAKEFILE"
                echo "  DEVICE_MODEL := ${{ env.TARGET_DEVICE }}" >> "$MAKEFILE"
                echo "  DEVICE_DTS := ${{ env.DTS_BASENAME }}" >> "$MAKEFILE"
                echo "  DEVICE_PACKAGES := kmod-mt76-connac kmod-mt7603 kmod-mt76x2" >> "$MAKEFILE"
                echo "endef" >> "$MAKEFILE"
                echo "TARGET_DEVICES += ${{ env.DEVICE_PROFILE }}" >> "$MAKEFILE"
              fi
            fi
            
            echo "âœ… Makefile å·²æ›´æ–°"
            echo "ğŸ” æ›´æ–°åçš„ Makefile å†…å®¹:"
            grep -A 5 "${{ env.DTS_BASENAME }}" "$MAKEFILE" || cat "$MAKEFILE" | tail -n 10
          else
            echo "â„¹ï¸ DTS å·²åŒ…å«åœ¨ Makefile ä¸­ï¼Œæ— éœ€ä¿®æ”¹"
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ° Makefile: $MAKEFILEï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®"
        fi

    - name: ğŸ›ï¸ é…ç½®ç¼–è¯‘é€‰é¡¹
      run: |
        cd source
        make defconfig
        
        # è®¾ç½®ç›®æ ‡æ¶æ„
        echo "CONFIG_TARGET=${{ env.TARGET }}" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}=y" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}=y" >> .config
        echo "CONFIG_TARGET_${{ env.TARGET }}_${{ env.SUBTARGET }}_DEVICE_${{ env.DEVICE_PROFILE }}=y" >> .config
        
        # é…ç½® U-Boot
        if [ -n "u-boot-mediatek" ]; then
          echo "CONFIG_PACKAGE_u-boot-mediatek=y" >> .config
          echo "CONFIG_PACKAGE_u-boot-mediatek-images=y" >> .config
        fi
        
        # é…ç½®åŠŸèƒ½
        printf "%s\\n" \
          "CONFIG_PACKAGE_luci=y" \
          "CONFIG_PACKAGE_relayd=y" \
          "CONFIG_PACKAGE_odhcpd_ipv6only=y" \
          "CONFIG_PACKAGE_samba36-server=y" \
          >> .config
        
        # å¦‚æœæœ‰WiFièŠ¯ç‰‡ï¼Œç¡®ä¿ç›¸å…³é©±åŠ¨è¢«åŒ…å«
        echo "CONFIG_PACKAGE_kmod-MT7976CN=y" >> .config
        echo "CONFIG_PACKAGE_kmod-MT7976CN=y" >> .config
        echo "CONFIG_PACKAGE_kmod-MT7531AE=y" >> .config
        
        make defconfig
        cat .config | grep -E 'CONFIG_TARGET|DEVICE_PROFILE|u-boot-mediatek|luci|relayd|odhcpd|samba'

    - name: ğŸ—ï¸ ç¼–è¯‘å›ºä»¶
      run: |
        cd source
        make -j$(nproc) V=s

    - name: ğŸ” æ£€æŸ¥å›ºä»¶å¤§å°
      run: |
        FIRMWARE_DIR=source/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}
        find $FIRMWARE_DIR -type f -name "*.bin" -o -name "*.img*" | xargs ls -lh
        for bin in $FIRMWARE_DIR/*.bin; do
          [ -f "$bin" ] || continue
          size=$(stat -c%s "$bin")
          echo "$bin -> $size bytes"
          if [ $size -gt 52428800 ]; then
            echo "âŒ å›ºä»¶è¶…å‡ºé¢„ä¼°é—ªå­˜é™åˆ¶ï¼Œè¯·ç²¾ç®€åŠŸèƒ½æˆ–æ¢å¤§å®¹é‡è®¾å¤‡ã€‚"
            exit 1
          fi
        done

    - name: ğŸ“¦ ä¿å­˜æ‰€æœ‰è¾“å‡ºä¸º Artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ github.event.inputs.target_device }}-${{ github.run_number }}
        path: |
          source/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/**
          source/build_dir/target*/logs/*.log
          source/staging_dir/toolchain*/info.mk
        retention-days: 90
        if-no-files-found: error

    - name: ğŸ“ ä¸‹è½½æŒ‡å¼•
      run: |
        echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
        echo "ğŸ“¥ å›ºä»¶å·²ä½œä¸º Artifact ä¿å­˜ï¼Œè¯·å‰å¾€ï¼š"
        echo "ğŸ”— https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "ğŸ“‚ ä¸‹è½½åä¸º 'firmware-MediaTek MT7981 RFB-X' çš„å‹ç¼©åŒ…è·å–å›ºä»¶æ–‡ä»¶ã€‚"
        echo ""
        echo "ğŸ’¡ é‡è¦æç¤º: ç¡®ä¿ä½¿ç”¨åŒ¹é…çš„ U-Boot ç‰ˆæœ¬:"
        echo "   - U-Boot åŒ…: u-boot-mediatek"
        echo "   - DTS æ–‡ä»¶: ${{ env.DTS_FILENAME }}"
        echo "   - å›ºä»¶ç›®æ ‡: ${{ env.TARGET }}/${{ env.SUBTARGET }} DEVICE=${{ env.DEVICE_PROFILE }}"
